ARG CUDA_VERSION=11.1

FROM ubuntu:latest AS build

ARG CUDA_VERSION

# install cmake, google-cloud-sdk (gsutil), then conda and pip packages
# NOTE: ignore apt-utils warnings: we don't want interactive install anyway!
RUN sed -i 's/^#force_color_prompt=yes$/force_color_prompt=yes/' ~/.bashrc \
    && apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
      curl wget apt-transport-https ca-certificates gnupg-agent software-properties-common \
      $(apt-cache search ^nvidia-driver- | grep "NVIDIA driver" | cut -d' ' -f1 | tail -n1) \
    && apt-get autoremove && apt-get clean

RUN wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh \
    && bash miniconda.sh -b -p "/opt/conda" \
    && export PATH="/opt/conda/bin:$PATH" \
    && conda init bash \
    && conda config \
    && . /opt/conda/etc/profile.d/conda.sh \
    && conda update -n base -c defaults conda -y \
    && conda config --prepend channels conda-forge \
    && conda config --prepend channels pytorch \
    && conda install -n base -y python=$PYTHON_VERSION \
    && conda install -n base -y --freeze-installed \
        psutil pympler pexpect \
        scipy scikit-learn pandas dill \
        seaborn matplotlib-base jupyter conda-pack \
        cython cudatoolkit=$CUDA_VERSION \
    && conda install -n base -y --freeze-installed -c bioconda \
        pybedtools pytabix pysam \
    && conda run -n base pip install --no-cache-dir \
        torch

ENV PATH="/opt/conda/bin:$PATH"

# Use conda-pack to create a standalone enviornment
# in /venv:
RUN conda-pack -o /tmp/env.tar && \
  mkdir /venv && cd /venv && tar xf /tmp/env.tar && \
  rm /tmp/env.tar

# We've put venv in same path it'll be in final image,
# so now fix up paths:
RUN /venv/bin/conda-unpack

from ubuntu:latest

# Copy /venv from the previous stage:
COPY --from=build /venv /venv

# When image is run, run the code with the environment
# activated:
RUN touch /root/.bashrc && echo "source /venv/bin/activate" >> /root/.bashrc \
  && sed -i 's/^#force_color_prompt=yes$/force_color_prompt=yes/' /root/.bashrc
